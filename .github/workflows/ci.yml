name: CI

on:
    push:
        branches: ["**"]
    pull_request:
        branches: ["**"]

env:
    BUN_VERSION: "1.2.14"

jobs:
    build:
        runs-on: ubuntu-latest
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
        outputs:
            artifact-name: ${{ steps.set-artifact-name.outputs.artifact-name }}

        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
            - name: Setup Environment
              id: setup
              uses: ./.github/actions/setup-env
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: Set Artifact Name
              id: set-artifact-name
              shell: bash
              run: |
                  SAFE_BRANCH="${GITHUB_REF_NAME//\//-}"
                  SHORT_SHA="${GITHUB_SHA::7}"
                  echo "artifact-name=obsidian-bases-charts-${SAFE_BRANCH}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

            - name: Check types
              if: (success() || failure()) && steps.setup.outcome == 'success'
              run: bun run typecheck
            - name: Build
              if: (success() || failure()) && steps.setup.outcome == 'success'
              run: bun run build
            - name: Lint
              if: (success() || failure()) && steps.setup.outcome == 'success'
              run: bun run lint
            - name: Test
              if: (success() || failure()) && steps.setup.outcome == 'success'
              run: bun run test:coverage

            - name: Upload Build Artifacts
              if: (success() || failure()) && steps.setup.outcome == 'success'
              uses: actions/upload-artifact@v6
              with:
                  name: ${{ steps.set-artifact-name.outputs.artifact-name }}
                  path: |
                      main.js
                      manifest.json
                      styles.css

            - name: Upload Coverage
              if: (success() || failure()) && steps.setup.outcome == 'success'
              uses: actions/upload-artifact@v6
              with:
                  name: coverage
                  path: coverage/

    e2e:
        needs: build
        runs-on: ubuntu-latest
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository

        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

            - name: Setup Environment
              id: setup
              uses: ./.github/actions/setup-env
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: Download Build Artifacts
              uses: actions/download-artifact@v8
              with:
                  name: ${{ needs.build.outputs.artifact-name }}

            - name: Setup Linux Environment
              run: |
                  sudo apt-get update
                  sudo apt-get install -y herbstluftwm

            - name: Cache Obsidian
              uses: actions/cache@v5
              with:
                  path: .obsidian-cache
                  key: obsidian-cache-${{ runner.os }}-${{ hashFiles('bun.lock', 'wdio.conf.mts') }}
                  restore-keys: |
                      obsidian-cache-${{ runner.os }}-

            - name: Run E2E Tests
              run: xvfb-run --auto-servernum --server-args="-screen 0 1280x1024x24" bash -c "herbstluftwm & bun run test:e2e"
